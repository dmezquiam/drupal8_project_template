<?php
/**
 * @file
 * Code for the Opportunity feature.
 */

include_once 'fe_opportunity.features.inc';

/**
 * Implements hook_theme()
 */

function fe_opportunity_theme() {
  return array(
    'node__training_opportunity' => array(
      'variables' => array('node' => array()),
      'template' => 'theme/node--training_opportunity',
    ),  
  );  
}

/**
 * Implements hook_preprocess_node()
 */

function fe_opportunity_preprocess_node(&$vars) {
  if ($vars['node']->type == 'training_opportunity') {
    $node = $vars['node'];
    if ($node->field_deadline && isset($node->field_deadline)) {
      global $language;
      $date = $node->field_deadline[$language->language][0]['value'];
      $vars['deadline_month'] = date('M j', $date);
      $vars['deadline_year'] = date('Y', $date);
    }
    $vars['path'] = url('node/' . $node->nid);
  }
}

/**
 * Implements hook_options_list().
 */
function fe_opportunity_field_widget_form_alter(&$element, &$form_state, $context) {
  if ($context['field']['type'] == 'taxonomy_term_reference' && $context['field']['settings']['allowed_values'][0]['vocabulary'] == 'topic') {
    // kpr($element);
    // kpr($form_state);
    // kpr($context);
  }
}

/**
 * Implementation of hook_query_term_access_alter().
 *
 * Rewrite taxonomy term queries so language selection options are enforced.
 */
function fe_opportunity_query_term_access_alter(QueryAlterableInterface $query) {
  if (module_exists('i18n_taxonomy') && i18n_select_mode('taxonomy') && i18n_select_check_query($query, 'tid') &&
    ($table_alias = i18n_select_check_table($query, 'taxonomy_term_data', 'tid'))) {
    $node = menu_get_object();
    $language = i18n_select_langcodes();
    if (isset($node)) {
      $language = $node->language;
    }
    $query->condition($table_alias . '.language', $language);
    // Mark query as altered
    $query->addTag('i18n_select');
  }
}

/**
 * Implements hook_form_alter
 */

function fe_opportunity_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'views_exposed_form' && $form['#id'] == 'views-exposed-form-opportunities-views-opportunities-landing') {
    $form['field_category_tid']['#options']['All'] = t('Any');
    $form['field_region_tid']['#options']['All'] = t('Any');
    $form['keys']['#attributes']['placeholder'] = t('Search term...');
    $title = array('filter-search_title' => array("operator" => 'search_title_op', "value" => "search_title", "label" => '', "description" => ''));
    $form['#info'] = $title + $form['#info'];
    $form['search_title']['#markup'] = '<h3>' . t('SEARCH OPPORTUNITIES') . '</h3>';
  }
}
