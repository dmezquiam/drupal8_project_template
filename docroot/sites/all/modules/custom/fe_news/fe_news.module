<?php
/**
 * @file
 * Code for the News feature.
 */

include_once 'fe_news.features.inc';

/**
 * Implements hook_preprocess_node()
 */

function fe_news_preprocess_node(&$variables) {
  $node = $variables['node'];
  if ($node->type == 'news') {
    $author = '';
    if (!empty($node->field_attribution)) {
      $author = $node->field_attribution[$node->language][0]['value'];
    }
    else if (!empty($node->field_byline)) {
      $user = user_load($node->field_byline[$node->language][0]['uid']);
      $author = _fe_news_get_author_link($user);
    }
    else {
      $user = user_load($node->uid);
      $author = _fe_news_get_author_link($user);
    }

    $variables['author'] = $author;

    global $base_url;
    $href = $base_url.$variables['node_url'];
    drupal_add_html_head_link(
        array('rel' => 'canonical', 'href' => $href),
        true
    );
  }
}

/**
 * Returns the author name linked to it's profile
 */
function _fe_news_get_author_link($user) {
  return l($user->field_screen_name[LANGUAGE_NONE][0]['value'],'user/'.$user->uid);
}


/**
 * Implements hook_theme()
 */

function fe_news_theme() {
  $themes = array(
    'node__news' => array(
      'variables' => array('node' => array()),
      'template' => 'theme/node--news',
    ),
    'last_posts_authors' => array(
      'variables' => array(
        'authors' => NULL,
      ),
      'template' => 'last-posts-authors',
      'path' => drupal_get_path('module', 'fe_news') . '/theme',
    ),
  );

  return $themes;
}

/**
 * Implements hook_block_info()
 */

function fe_news_block_info() {
  $blocks = array();

  $blocks['last_posts_authors']  = array('info' => 'Gets authors for the last 10 posts.');

  return $blocks;
}

/**
 * Implements hook_block_view()
 */

function fe_news_block_view($delta = '') {
  $block = array();
  $vars = array();

  if ($delta == 'last_posts_authors') {
    $block = array(
      'subjet' => NULL,
      'content' => _fe_news_get_last_posts_authors(),
    );
  }

  return $block;
}

function _fe_news_get_last_posts_authors() {
  $authors = array();
  $authors_uid = array();

  $view = views_get_view('last_posts');
  if ($view) {
    $view->set_display('block');
    $view->execute();
    foreach($view->result as $content){
      if (sizeof($authors) < 10) {
        $author = _fe_news_get_author($content->nid);

        $user = user_load($author->uid);
        if ($user->field_show_profile != NULL) {

          if (isset($author->uid)) {
            if (!in_array($author->uid, $authors_uid)) {
              $authors_uid[] = $author->uid;
              $authors[] = $author;
            }
          } else {
            if (!in_array($author->name, $authors_uid)) {
              $authors_uid[] = $author->name;
              $authors[] = $author;
            }
          }
        }
      }
    }
  }

  return theme('last_posts_authors', array('authors' => $authors));
}

function _fe_news_get_author($nid) {
  $node = node_load($nid);
  $language = $node->language;

  $author = new stdClass();
  if (!empty($node->field_attribution)) {
    $author->name = (isset($node->field_attribution[$language])) ?
      $node->field_attribution[$language][0]['safe_value'] :
      $node->field_attribution[LANGUAGE_NONE][0]['safe_value'];
  } else {
    if (!empty($node->field_byline)) {
      $user = (isset($node->field_byline[$language])) ?
      user_load($node->field_byline[$language][0]['uid']) :
      user_load($node->field_byline[LANGUAGE_NONE][0]['uid']);
    } else {
      $user = user_load($node->uid);
    }
    $author->uid = $user->uid;
    $author->name = $user->field_screen_name[LANGUAGE_NONE][0]['safe_value'];
    $author->profile_link = drupal_get_path_alias(t('PROFILE POSTS'), '/user/'.$user->uid);
    $author->avatar = isset($user->picture) ? 
      theme_image_style(array(
        'path' => $user->picture->uri, 
        'style_name' => 'avatar_small_img', 
        'width' => '110', 
        'height' => '110')
        ) :  null;
    $author->job = isset($user->field_job_title[LANGUAGE_NONE]) ?
      $user->field_job_title[LANGUAGE_NONE][0]['safe_value'] : null;
    $author->organization = isset($user->field_organization_name[LANGUAGE_NONE]) ?
      $user->field_organization_name[LANGUAGE_NONE][0]['safe_value'] : null;
  }

  return $author;
}

/**
 * Implements hook_form_alter()
 */

function fe_news_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'comment_node_news_form') {
    hide($form['author']);
  }
}
